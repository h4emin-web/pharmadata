import pandas as pd
import requests
from bs4 import BeautifulSoup
import os
import re
from tqdm import tqdm
from concurrent.futures import ThreadPoolExecutor, as_completed

# --- ì„¤ì • êµ¬ê°„ ---
MAX_WORKERS = 10  # ë™ì‹œì— ì—´ í˜ì´ì§€ ìˆ˜ (ì»´í“¨í„° ì„±ëŠ¥/ì¸í„°ë„·ì— ë”°ë¼ 5~20 ì‚¬ì´ ì¡°ì ˆ)

def fetch_data(item_seq):
    """í•œ í˜ì´ì§€ë¥¼ ì½ì–´ì™€ì„œ ì•½ê°€ì™€ ì˜ë¬¸ëª…ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜"""
    if not item_seq or item_seq == 'nan' or item_seq == "":
        return "", ""

    base_url = f"https://nedrug.mfds.go.kr/pbp/CCBBB01/getItemDetail?itemSeq={item_seq}"
    try:
        # ì†ë„ë¥¼ ìœ„í•´ timeoutì„ ì§§ê²Œ ì„¤ì •
        response = requests.get(base_url, timeout=5)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        price_val = ""
        atc_eng_name = ""

        for th in soup.find_all('th'):
            text = th.get_text()
            if 'ë³´í—˜ì•½ê°€' in text:
                td = th.find_next_sibling('td')
                if td:
                    match = re.search(r'(\d+ì›)', td.get_text(strip=True))
                    if match: price_val = match.group(1)
            elif 'ATCì½”ë“œ' in text:
                td = th.find_next_sibling('td')
                if td:
                    match = re.search(r'\((.*?)\)', td.get_text(strip=True))
                    if match: atc_eng_name = match.group(1).strip()
            
            # ë‘˜ ë‹¤ ì°¾ì•˜ìœ¼ë©´ ì¼ì° ì¢…ë£Œ
            if price_val and atc_eng_name: break

        return price_val, atc_eng_name
    except:
        return "ì˜¤ë¥˜", "ì˜¤ë¥˜"

def main():
    user_name = os.getlogin()
    file_path = f'C:/Users/{user_name}/Desktop/data10000.xlsx'
    save_path = f'C:/Users/{user_name}/Desktop/data10000_ìµœì¢…ì™„ì„±.xlsx'

    if not os.path.exists(file_path):
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    print("ğŸ“‚ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...")
    df = pd.read_excel(file_path)
    item_seqs = [str(val).strip() for val in df.iloc[:, 0]]
    total = len(item_seqs)

    results = [None] * total

    print(f"âš¡ ë©€í‹°ì“°ë ˆë”© ê°€ë™ (ë™ì‹œ ì‘ì—… ìˆ˜: {MAX_WORKERS})...")
    
    # ë©€í‹°ì“°ë ˆë“œ ì‹¤í–‰
    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        # ì‘ì—… ë“±ë¡
        future_to_index = {executor.submit(fetch_data, seq): i for i, seq in enumerate(item_seqs)}
        
        # ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ ê²°ê³¼ ê¸°ë¡ (tqdmìœ¼ë¡œ ì§„í–‰ ë°” í‘œì‹œ)
        for future in tqdm(as_completed(future_to_index), total=total, desc="ì´ˆê³ ì† ì¶”ì¶œ ì¤‘"):
            index = future_to_index[future]
            results[index] = future.result()

    # ê²°ê³¼ ë°ì´í„°ë¥¼ ì—‘ì…€ì— ì±„ìš°ê¸°
    print("\nâœï¸ ë°ì´í„°ë¥¼ ì—‘ì…€ì— ê¸°ì… ì¤‘...")
    for i, (price, eng) in enumerate(results):
        df.iloc[i, 5] = price  # Fì—´
        df.iloc[i, 7] = eng    # Hì—´

    df.to_excel(save_path, index=False)
    print(f"âœ… ì‘ì—… ì™„ë£Œ! ì €ì¥ ìœ„ì¹˜: {save_path}")

if __name__ == "__main__":
    main()
